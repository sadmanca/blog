<html lang="en">
 <head>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.css">
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
   <script src="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/ag-grid-enterprise/dist/ag-grid-enterprise.min.js"></script>
   <style>
    .cell-wrap-text {
      white-space: normal !important;
    }

    .ag-theme-quartz .ag-cell-value {
      line-height: 15px !important;
      word-break: break-word;
      padding-top: 5px;
      padding-bottom: 5px;
    }

    .cell-ellipsis {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
    }

    .scrollable-cell {
      /* max-height: 100px; */
      overflow-y: auto; Enables vertical scrolling
    }

    .simplebar-scrollbar::before {
      background-color: rgba(0, 0, 0, 0.1); /* Red with 50% opacity */
    }

    .scrollable-cell:hover .simplebar-scrollbar::before {
      background-color: rgba(0, 0, 0, 0.75); /* Red with 50% opacity */
    }

    /* Flexbox layout for body */
    body {
      display: flex;
      flex-direction: column; /* Stack elements vertically */
      height: 100vh; /* Full viewport height */
      margin: 0; /* Remove default margin */
    }

    /* Container for buttons */
    .button-container {
      flex-shrink: 0; /* Prevent shrinking */
      margin: 10px 0;
      overflow-x: auto; /* Enable horizontal scrolling for buttons */
    }

    /* Adjusted grid container */
    #myGrid {
      flex-grow: 1; /* Allow the grid to take up remaining space */
      width: 100%; /* Full width */
      /* Removed fixed height to allow flexbox to control the size */
    }

    .ag-theme-quartz {
      /* --ag-grid-size: 3px;  */
      /* --ag-header-height: 80px; */
    }

  </style>
  <noscript>
    <style>
      /**
      * Reinstate scrolling for non-JS clients
      */
      .simplebar-content-wrapper {
        scrollbar-width: auto;
        -ms-overflow-style: auto;
      }

      .simplebar-content-wrapper::-webkit-scrollbar,
      .simplebar-hide-scrollbar::-webkit-scrollbar {
        display: initial;
        width: initial;
        height: initial;
      }
    </style>
  </noscript>
 </head>
  <body>
    <div style="margin: 10px 0">
      <button class="btn btn-primary" onclick="exportAllRowsToCSV()">Download CSV</button>
      <button class="btn btn-success" onclick="exportAllRowsToExcel()">Download Excel</button>
      <button class="btn btn-outline-primary btn-sm" disabled onclick="exportSelectedRowsToCSV()">Export Selected Rows to CSV</button>
      <button class="btn btn-outline-success btn-sm" disabled onclick="exportSelectedRowsToExcel()">Export Selected Rows to Excel</button>
    </div>
    <div id="myGrid" style="width: 100%; height: 100%" class="ag-theme-quartz"></div>
  </body>
</html>

<script>
  function scrollableCellRenderer(params) {
    // Check if params.value exists and replace newline characters with HTML line breaks
    const formattedValue = params.value ? params.value.replace(/\n/g, '<br><br>') : '';
    return `<div class="scrollable-cell" data-simplebar data-simplebar-auto-hide="false">${formattedValue}</div>`;
  }

  function CompanyWebsiteRenderer(params) {
    // Ensure params.value is defined and is a string
    if (typeof params.value !== 'string') return '';

    // Extract the first URL from the text
    const urlMatch = params.value.match(/https?:\/\/[^ \n]+/);
    if (!urlMatch) return params.value; // Return original text if no URL found

    const firstUrl = urlMatch[0];
    const link = `<a href="${firstUrl}" target="_blank">${new URL(firstUrl).hostname}</a>`;
    return link;
  }

  function updateExportButtonsState() {
    const noRowsSelected = gridApi && gridApi.getSelectedRows().length === 0;
    document.querySelector('button[onclick="exportSelectedRowsToCSV()"]').disabled = noRowsSelected;
    document.querySelector('button[onclick="exportSelectedRowsToExcel()"]').disabled = noRowsSelected;
  }

  function MultiLineTextCellEditor() {}

  MultiLineTextCellEditor.prototype.init = function(params) {
    this.params = params;
    this.eGui = document.createElement('textarea');
    this.eGui.style.width = '100%';
    this.eGui.style.height = '100%';
    this.eGui.value = params.value;
  };

  MultiLineTextCellEditor.prototype.getGui = function() {
    return this.eGui;
  };

  MultiLineTextCellEditor.prototype.afterGuiAttached = function() {
    this.eGui.focus();
    this.eGui.select();
  };

  MultiLineTextCellEditor.prototype.getValue = function() {
    return this.eGui.value;
  };

  MultiLineTextCellEditor.prototype.destroy = function() {};

  const gridOptions = {
    columnDefs: [
      // {
      //   headerName: "Row",
      //   maxWidth: 100,
      //   // it is important to have node.id here, so that when the id changes (which happens
      //   // when the row is loaded) then the cell is refreshed.
      //   valueGetter: "node.id",
      //   cellRenderer: (params) => {
      //     if (params.value !== undefined) {
      //       return params.value;
      //     } else {
      //       return '<img src="https://www.ag-grid.com/example-assets/loading.gif">';
      //     }
      //   },
      // },
      {
        headerCheckboxSelection: true, // Enable checkbox on the header
        checkboxSelection: true, // Enable row checkboxes
        field: "postingDate",
        width: 140,
        rowGroup: true,
        hide: false,
        pinned: 'left',
        filter: "agSetColumnFilter",
      },
      {
        field: "title",
        width: 120,
        pinned: 'left',
      },
      {
        field: "company",
        rowGroup: true,
        width: 117,
      },
      {
        field: "companyWebsite",
        cellRenderer: CompanyWebsiteRenderer,
        width: 117,
      },
      {
        field: "location",
        width: 113,
      },
      {
        field: "locationType",
        width: 113,
      },
      {
        field: "numPositions",
        headerName: "Num of Positions",
        width: 115,
        filter: "agSetColumnFilter",
        // Use a value formatter to check the value before displaying
        valueFormatter: function(params) {
          // Check if the value is a valid number
          const isValidNumber = !isNaN(params.value) && isFinite(params.value);
          // Return the value if it's a valid number, otherwise return an empty string
          return isValidNumber ? params.value : '';
        },
      },
      {
        field: "description",
        width: 350,
        wrapText: true,
        // cellClass: 'cell-wrap-text',
        // autoHeight: true,
        cellRenderer: scrollableCellRenderer,
        filter: 'agTextColumnFilter',
      },
      {
        field: "requirements",
        width: 350,
        wrapText: true,
        // cellClass: 'cell-wrap-text',
        // autoHeight: true,
        cellRenderer: scrollableCellRenderer,
        filter: 'agTextColumnFilter',
      },
      {
        field: "preferredDisciplines",
        width: 140,
        // wrapText: false,
        cellRenderer: scrollableCellRenderer,
        filter: 'agTextColumnFilter',
      },
      {
        field: "salary",
        width: 100,
      },
      {
        field: "startDate",
        width: 105,
        filterParams: {
          filters: [
            { filter: "agDateColumnFilter", },
            { filter: "agSetColumnFilter", },
          ],
        },
      },
      {
        field: "endDate",
        width: 105,
        filterParams: {
          filters: [
            { filter: "agDateColumnFilter", },
            { filter: "agSetColumnFilter", },
          ],
        },
      },
      {
        field: "companyDivision",
        width: 120,
      },
      {
        field: "function",
        width: 120,
      },
      {
      headerName: "Application",
      children: [
        {
          field: "applicationDeadline",
          width: 130,
          filter: 'agTextColumnFilter',
        },
        // Uncomment and include additional fields as needed
        // {
        //   field: "applicationMethod",
        // },
        {
          field: "applicationReceiptProcedure",
          headerName: "Application Procedure",
          width: 130,
          cellRenderer: scrollableCellRenderer,
          filter: 'agTextColumnFilter',
        },
        {
          field: "applicationDetails",
          width: 130,
          cellRenderer: scrollableCellRenderer,
          filter: 'agTextColumnFilter',
        },
        {
          field: "id",
          headerName: "Job ID",
          maxWidth: 100,
          filterParams: {
            filters: [
              { filter: "agNumberColumnFilter" },
              { filter: "agSetColumnFilter" },
            ],
          },
        },
      ]
    }
    ],

    defaultColDef: {
      resizable: true,
      sortable: true,
      initialWidth: 170,
      editable: true,
      filter: true,
      wrapText: true,
      cellEditor: MultiLineTextCellEditor,
      wrapHeaderText: true,
      autoHeaderHeight: true,
      floatingFilter: true,
      filter: "agMultiColumnFilter",
      filterParams: {
        filters: [
          { filter: "agTextColumnFilter", },
          { filter: "agSetColumnFilter", },
        ],
      },
      tooltipValueGetter: function(params) {
        // Assuming 'jobTitle' and 'company' are the field names in your rowData
        return `${params.data.title} at ${params.data.company}`;
      },
    },

    // rowHeight: 250,
    getRowHeight: function(params) {
      // Check if the row is a group row
      if (params.node.group) {
        // Return the desired height for group rows
        return 30; // Example: Set group row height to 100px
      }
      // Return a different height for non-group rows or default height
      return 250; // Example: Set non-group row height to 25px
    },
    rowSelection: 'multiple',
    onSelectionChanged: updateExportButtonsState,

    groupDefaultExpanded: -1,
    groupDisplayType: 'groupRows',

    tooltipShowDelay: 500,
    tooltipHideDelay: 1000,
    tooltipMouseTrack: true,

    statusBar: {
      statusPanels: [
       {
          statusPanel: "agTotalAndFilteredRowCountComponent",
          align: "left",
        },
       {
          statusPanel: "agSelectedRowCountComponent",
          align: "left",
        },
      ],
    },
    enableRangeSelection: true,
    // Function to determine if a row should be selectable
    isRowSelectable: function(rowNode) {
      // Return false if the row is a group row, making it not selectable
      return !rowNode.group;
    },

    sideBar: {
      toolPanels: [
        {
          id: "columns",
          labelDefault: "Columns",
          labelKey: "columns",
          iconKey: "columns",
          toolPanel: "agColumnsToolPanel",
          width: 250,
          toolPanelParams: {
            suppressValues: true, // This will hide the aggregation options
          },
        },
        {
          id: "filters",
          labelDefault: "Filters",
          labelKey: "filters",
          iconKey: "filter",
          toolPanel: "agFiltersToolPanel",
          width: 250,
        },
      ],
      defaultToolPanel: "columns",
    },

    pagination: true,
    paginationPageSize: 1,
    paginationPageSizeSelector: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],

  };

  function exportSelectedRowsToCSV() {
    if (gridApi) {
      gridApi.exportDataAsCsv({
        onlySelected: true,
      });
    } else {
      console.error('Grid API is not available.');
    }
  }

  function exportSelectedRowsToExcel() {
    if (gridApi) {
      gridApi.exportDataAsExcel({
        onlySelected: true,
      });
    } else {
      console.error('Grid API is not available.');
    }
  }

  function exportAllRowsToCSV() {
    if (gridApi) {
      gridApi.exportDataAsCsv({
        onlySelected: false,
      });
    } else {
      console.error('Grid API is not available.');
    }
  }

  function exportAllRowsToExcel() {
    if (gridApi) {
      gridApi.exportDataAsExcel({
        onlySelected: false,
      });
    } else {
      console.error('Grid API is not available.');
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    var gridDiv = document.querySelector("#myGrid");
    gridApi = agGrid.createGrid(gridDiv, gridOptions);

    fetch("/pages/JobPosting.json")
      .then((response) => response.json())
      .then((data) => gridApi.setGridOption("rowData", data));
  });
</script>

<!--
for mapping pages to dates:

// Example mapping of page numbers to dates
const pageNumberToDateMap = {
  1: '2023-01-01',
  2: '2023-01-02',
  // Add more mappings as needed
};
const lastDate = '2023-01-31'; // Example last date

const gridOptions = {
  // Other grid options...
  pagination: true,
  paginationPageSize: 1,
  paginationNumberFormatter: function(params) {
    const currentPageDate = pageNumberToDateMap[params.value] || 'Unknown Date';
    return `${currentPageDate} out of ${lastDate}`;
  },
  // Other options like columnDefs, rowData, etc.
};

<div class="ag-tooltip ag-tooltip-animate ag-ltr ag-popup-child ag-tooltip-hiding" role="dialog" aria-label="Tooltip" style="top: 279px; left: 1230px;">Full Stack Engineer, Business Systems at ecobee</div>
-->